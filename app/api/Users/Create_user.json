{
  "meta": {
    "$_GET": [
      {
        "type": "text",
        "name": "sort"
      },
      {
        "type": "text",
        "name": "dir"
      }
    ],
    "$_POST": [
      {
        "type": "text",
        "name": "FirstName"
      },
      {
        "type": "text",
        "name": "LastName"
      },
      {
        "type": "text",
        "name": "Email"
      },
      {
        "type": "text",
        "name": "Pasword"
      },
      {
        "type": "text",
        "name": "Role"
      },
      {
        "type": "text",
        "name": "Company"
      },
      {
        "type": "text",
        "name": "Department"
      },
      {
        "type": "boolean",
        "name": "Create_Update_team_Tasks"
      },
      {
        "type": "boolean",
        "name": "Create_Update_team_Events"
      },
      {
        "type": "boolean",
        "name": "Account_settings_and_subscription"
      },
      {
        "type": "boolean",
        "name": "Company_founder"
      },
      {
        "type": "datetime",
        "name": "CreatedDate"
      },
      {
        "type": "datetime",
        "name": "UpdatedDate"
      },
      {
        "type": "text",
        "name": "CompanyName"
      },
      {
        "type": "text",
        "name": "CompanyID"
      },
      {
        "type": "text",
        "name": "company_email"
      }
    ]
  },
  "exec": {
    "steps": [
      {
        "name": "",
        "module": "core",
        "action": "condition",
        "options": {
          "if": "{{$_POST.CompanyName != null}}",
          "then": {
            "steps": [
              {
                "name": "insert_user_with_companyId",
                "module": "dbupdater",
                "action": "insert",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "insert",
                    "values": [
                      {
                        "table": "Users",
                        "column": "FirstName",
                        "type": "text",
                        "value": "{{$_POST.FirstName}}"
                      },
                      {
                        "table": "Users",
                        "column": "LastName",
                        "type": "text",
                        "value": "{{$_POST.LastName}}"
                      },
                      {
                        "table": "Users",
                        "column": "Email",
                        "type": "text",
                        "value": "{{$_POST.Email}}"
                      },
                      {
                        "table": "Users",
                        "column": "Pasword",
                        "type": "text",
                        "value": "{{$_POST.Pasword.sha512('slut')}}"
                      },
                      {
                        "table": "Users",
                        "column": "Role",
                        "type": "text",
                        "value": "Founder"
                      },
                      {
                        "table": "Users",
                        "column": "Department",
                        "type": "text",
                        "value": "{{$_POST.Department}}"
                      },
                      {
                        "table": "Users",
                        "column": "Create_Update_team_Tasks",
                        "type": "boolean",
                        "value": "1"
                      },
                      {
                        "table": "Users",
                        "column": "Create_Update_team_Events",
                        "type": "boolean",
                        "value": "1"
                      },
                      {
                        "table": "Users",
                        "column": "Account_settings_and_subscription",
                        "type": "boolean",
                        "value": "1"
                      },
                      {
                        "table": "Users",
                        "column": "Company_founder",
                        "type": "boolean",
                        "value": "1"
                      },
                      {
                        "table": "Users",
                        "column": "CreatedDate",
                        "type": "datetime",
                        "value": "{{NOW}}"
                      }
                    ],
                    "table": "Users",
                    "returning": "id",
                    "query": "INSERT INTO Users\n(FirstName, LastName, Email, Pasword, Role, Department, Create_Update_team_Tasks, Create_Update_team_Events, Account_settings_and_subscription, Company_founder, CreatedDate) VALUES (:P1 /* {{$_POST.FirstName}} */, :P2 /* {{$_POST.LastName}} */, :P3 /* {{$_POST.Email}} */, :P4 /* {{$_POST.Pasword.sha512('slut')}} */, 'Founder', :P5 /* {{$_POST.Department}} */, '1', '1', '1', '1', :P6 /* {{NOW}} */)",
                    "params": [
                      {
                        "name": ":P1",
                        "type": "expression",
                        "value": "{{$_POST.FirstName}}"
                      },
                      {
                        "name": ":P2",
                        "type": "expression",
                        "value": "{{$_POST.LastName}}"
                      },
                      {
                        "name": ":P3",
                        "type": "expression",
                        "value": "{{$_POST.Email}}"
                      },
                      {
                        "name": ":P4",
                        "type": "expression",
                        "value": "{{$_POST.Pasword.sha512('slut')}}"
                      },
                      {
                        "name": ":P5",
                        "type": "expression",
                        "value": "{{$_POST.Department}}"
                      },
                      {
                        "name": ":P6",
                        "type": "expression",
                        "value": "{{NOW}}"
                      }
                    ]
                  }
                },
                "meta": [
                  {
                    "name": "identity",
                    "type": "text"
                  },
                  {
                    "name": "affected",
                    "type": "number"
                  }
                ]
              },
              {
                "name": "createCustomer",
                "module": "stripe",
                "action": "createCustomer",
                "options": {
                  "description": "{{$_POST.CompanyName}}",
                  "email": "{{$_POST.company_email}}",
                  "name": "{{$_POST.CompanyName}}"
                },
                "outputType": "object",
                "meta": [
                  {
                    "name": "address",
                    "type": "object",
                    "ref": "stripe_address"
                  },
                  {
                    "name": "balance",
                    "type": "number"
                  },
                  {
                    "name": "created",
                    "type": "number"
                  },
                  {
                    "name": "currency",
                    "type": "text"
                  },
                  {
                    "name": "default_source",
                    "type": "text",
                    "expand": [
                      "stripe_payment_source"
                    ]
                  },
                  {
                    "name": "delinquent",
                    "type": "boolean"
                  },
                  {
                    "name": "description",
                    "type": "text"
                  },
                  {
                    "name": "discount",
                    "type": "object",
                    "ref": "stripe_discount"
                  },
                  {
                    "name": "email",
                    "type": "text"
                  },
                  {
                    "name": "id",
                    "type": "text"
                  },
                  {
                    "name": "invoice_prefix",
                    "type": "text"
                  },
                  {
                    "name": "invoice_settings",
                    "type": "object",
                    "ref": "stripe_invoice_setting_customer_setting"
                  },
                  {
                    "name": "livemode",
                    "type": "boolean"
                  },
                  {
                    "name": "metadata",
                    "type": "object"
                  },
                  {
                    "name": "name",
                    "type": "text"
                  },
                  {
                    "name": "next_invoice_sequence",
                    "type": "number"
                  },
                  {
                    "name": "object",
                    "type": "text"
                  },
                  {
                    "name": "phone",
                    "type": "text"
                  },
                  {
                    "name": "preferred_locales",
                    "type": "array",
                    "sub": []
                  },
                  {
                    "name": "shipping",
                    "type": "object",
                    "ref": "stripe_shipping"
                  },
                  {
                    "name": "sources",
                    "type": "object",
                    "sub": [
                      {
                        "name": "data",
                        "type": "array",
                        "sub": [
                          {
                            "name": "payment_source",
                            "type": "object"
                          }
                        ]
                      },
                      {
                        "name": "has_more",
                        "type": "boolean"
                      },
                      {
                        "name": "object",
                        "type": "text"
                      },
                      {
                        "name": "url",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "name": "subscriptions",
                    "type": "object",
                    "sub": [
                      {
                        "name": "data",
                        "type": "array",
                        "sub": [
                          {
                            "name": "billing_cycle_anchor",
                            "type": "number"
                          },
                          {
                            "name": "billing_thresholds",
                            "type": "object",
                            "ref": "stripe_subscription_billing_thresholds"
                          },
                          {
                            "name": "cancel_at",
                            "type": "number"
                          },
                          {
                            "name": "cancel_at_period_end",
                            "type": "boolean"
                          },
                          {
                            "name": "canceled_at",
                            "type": "number"
                          },
                          {
                            "name": "collection_method",
                            "type": "text"
                          },
                          {
                            "name": "created",
                            "type": "number"
                          },
                          {
                            "name": "current_period_end",
                            "type": "number"
                          },
                          {
                            "name": "current_period_start",
                            "type": "number"
                          },
                          {
                            "name": "customer",
                            "type": "text",
                            "expand": [
                              "stripe_customer",
                              "stripe_deleted_customer"
                            ]
                          },
                          {
                            "name": "days_until_due",
                            "type": "number"
                          },
                          {
                            "name": "default_payment_method",
                            "type": "text",
                            "expand": [
                              "stripe_payment_method"
                            ]
                          },
                          {
                            "name": "default_source",
                            "type": "text",
                            "expand": [
                              "stripe_payment_source"
                            ]
                          },
                          {
                            "name": "default_tax_rates",
                            "type": "array",
                            "sub": [
                              {
                                "name": "active",
                                "type": "boolean"
                              },
                              {
                                "name": "country",
                                "type": "text"
                              },
                              {
                                "name": "created",
                                "type": "number"
                              },
                              {
                                "name": "description",
                                "type": "text"
                              },
                              {
                                "name": "display_name",
                                "type": "text"
                              },
                              {
                                "name": "id",
                                "type": "text"
                              },
                              {
                                "name": "inclusive",
                                "type": "boolean"
                              },
                              {
                                "name": "jurisdiction",
                                "type": "text"
                              },
                              {
                                "name": "livemode",
                                "type": "boolean"
                              },
                              {
                                "name": "metadata",
                                "type": "object"
                              },
                              {
                                "name": "object",
                                "type": "text"
                              },
                              {
                                "name": "state",
                                "type": "text"
                              }
                            ]
                          },
                          {
                            "name": "discount",
                            "type": "object",
                            "ref": "stripe_discount"
                          },
                          {
                            "name": "ended_at",
                            "type": "number"
                          },
                          {
                            "name": "id",
                            "type": "text"
                          },
                          {
                            "name": "items",
                            "type": "object",
                            "sub": [
                              {
                                "name": "data",
                                "type": "array",
                                "sub": [
                                  {
                                    "name": "billing_thresholds",
                                    "type": "object",
                                    "ref": "stripe_subscription_item_billing_thresholds"
                                  },
                                  {
                                    "name": "created",
                                    "type": "number"
                                  },
                                  {
                                    "name": "id",
                                    "type": "text"
                                  },
                                  {
                                    "name": "metadata",
                                    "type": "object"
                                  },
                                  {
                                    "name": "object",
                                    "type": "text"
                                  },
                                  {
                                    "name": "plan",
                                    "type": "object",
                                    "ref": "stripe_plan"
                                  },
                                  {
                                    "name": "price",
                                    "type": "object",
                                    "ref": "stripe_price"
                                  },
                                  {
                                    "name": "quantity",
                                    "type": "number"
                                  },
                                  {
                                    "name": "subscription",
                                    "type": "text"
                                  },
                                  {
                                    "name": "tax_rates",
                                    "type": "array",
                                    "sub": [
                                      {
                                        "name": "active",
                                        "type": "boolean"
                                      },
                                      {
                                        "name": "country",
                                        "type": "text"
                                      },
                                      {
                                        "name": "created",
                                        "type": "number"
                                      },
                                      {
                                        "name": "description",
                                        "type": "text"
                                      },
                                      {
                                        "name": "display_name",
                                        "type": "text"
                                      },
                                      {
                                        "name": "id",
                                        "type": "text"
                                      },
                                      {
                                        "name": "inclusive",
                                        "type": "boolean"
                                      },
                                      {
                                        "name": "jurisdiction",
                                        "type": "text"
                                      },
                                      {
                                        "name": "livemode",
                                        "type": "boolean"
                                      },
                                      {
                                        "name": "metadata",
                                        "type": "object"
                                      },
                                      {
                                        "name": "object",
                                        "type": "text"
                                      },
                                      {
                                        "name": "state",
                                        "type": "text"
                                      }
                                    ]
                                  }
                                ]
                              },
                              {
                                "name": "has_more",
                                "type": "boolean"
                              },
                              {
                                "name": "object",
                                "type": "text"
                              },
                              {
                                "name": "url",
                                "type": "text"
                              }
                            ]
                          },
                          {
                            "name": "latest_invoice",
                            "type": "text",
                            "expand": [
                              "stripe_invoice"
                            ]
                          },
                          {
                            "name": "livemode",
                            "type": "boolean"
                          },
                          {
                            "name": "metadata",
                            "type": "object"
                          },
                          {
                            "name": "next_pending_invoice_item_invoice",
                            "type": "number"
                          },
                          {
                            "name": "object",
                            "type": "text"
                          },
                          {
                            "name": "pause_collection",
                            "type": "object",
                            "ref": "stripe_subscriptions_resource_pause_collection"
                          },
                          {
                            "name": "pending_invoice_item_interval",
                            "type": "object",
                            "ref": "stripe_subscription_pending_invoice_item_interval"
                          },
                          {
                            "name": "pending_setup_intent",
                            "type": "text",
                            "expand": [
                              "stripe_setup_intent"
                            ]
                          },
                          {
                            "name": "pending_update",
                            "type": "object",
                            "ref": "stripe_subscriptions_resource_pending_update"
                          },
                          {
                            "name": "schedule",
                            "type": "text",
                            "expand": [
                              "stripe_subscription_schedule"
                            ]
                          },
                          {
                            "name": "start_date",
                            "type": "number"
                          },
                          {
                            "name": "status",
                            "type": "text"
                          },
                          {
                            "name": "transfer_data",
                            "type": "object",
                            "ref": "stripe_subscription_transfer_data"
                          },
                          {
                            "name": "trial_end",
                            "type": "number"
                          },
                          {
                            "name": "trial_start",
                            "type": "number"
                          }
                        ]
                      },
                      {
                        "name": "has_more",
                        "type": "boolean"
                      },
                      {
                        "name": "object",
                        "type": "text"
                      },
                      {
                        "name": "url",
                        "type": "text"
                      }
                    ]
                  },
                  {
                    "name": "tax_exempt",
                    "type": "text"
                  },
                  {
                    "name": "tax_ids",
                    "type": "object",
                    "sub": [
                      {
                        "name": "data",
                        "type": "array",
                        "sub": [
                          {
                            "name": "country",
                            "type": "text"
                          },
                          {
                            "name": "created",
                            "type": "number"
                          },
                          {
                            "name": "customer",
                            "type": "text",
                            "expand": [
                              "stripe_customer"
                            ]
                          },
                          {
                            "name": "id",
                            "type": "text"
                          },
                          {
                            "name": "livemode",
                            "type": "boolean"
                          },
                          {
                            "name": "object",
                            "type": "text"
                          },
                          {
                            "name": "type",
                            "type": "text"
                          },
                          {
                            "name": "value",
                            "type": "text"
                          },
                          {
                            "name": "verification",
                            "type": "object",
                            "ref": "stripe_tax_id_verification"
                          }
                        ]
                      },
                      {
                        "name": "has_more",
                        "type": "boolean"
                      },
                      {
                        "name": "object",
                        "type": "text"
                      },
                      {
                        "name": "url",
                        "type": "text"
                      }
                    ]
                  }
                ]
              },
              {
                "name": "insert_Company",
                "module": "dbupdater",
                "action": "insert",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "insert",
                    "values": [
                      {
                        "table": "Company_Account",
                        "column": "CompanyName",
                        "type": "text",
                        "value": "{{$_POST.CompanyName}}"
                      },
                      {
                        "table": "Company_Account",
                        "column": "Created_date",
                        "type": "datetime",
                        "value": "{{NOW}}"
                      },
                      {
                        "table": "Company_Account",
                        "column": "Company_email",
                        "type": "text",
                        "value": "{{$_POST.company_email}}"
                      },
                      {
                        "table": "Company_Account",
                        "column": "Stripe_customer_id",
                        "type": "text",
                        "value": "{{createCustomer.id}}"
                      }
                    ],
                    "table": "Company_Account",
                    "returning": "id",
                    "query": "INSERT INTO Company_Account\n(CompanyName, Created_date, Company_email, Stripe_customer_id) VALUES (:P1 /* {{$_POST.CompanyName}} */, :P2 /* {{NOW}} */, :P3 /* {{$_POST.company_email}} */, :P4 /* {{createCustomer.id}} */)",
                    "params": [
                      {
                        "name": ":P1",
                        "type": "expression",
                        "value": "{{$_POST.CompanyName}}"
                      },
                      {
                        "name": ":P2",
                        "type": "expression",
                        "value": "{{NOW}}"
                      },
                      {
                        "name": ":P3",
                        "type": "expression",
                        "value": "{{$_POST.company_email}}"
                      },
                      {
                        "name": ":P4",
                        "type": "expression",
                        "value": "{{createCustomer.id}}"
                      }
                    ]
                  }
                },
                "meta": [
                  {
                    "name": "identity",
                    "type": "text"
                  },
                  {
                    "name": "affected",
                    "type": "number"
                  }
                ]
              },
              {
                "name": "insert_user_company_join_table",
                "module": "dbupdater",
                "action": "insert",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "insert",
                    "values": [
                      {
                        "table": "Companies_users",
                        "column": "userId",
                        "type": "text",
                        "value": "{{insert_user_with_companyId.identity}}"
                      },
                      {
                        "table": "Companies_users",
                        "column": "CompanyId",
                        "type": "text",
                        "value": "{{insert_Company.identity}}"
                      }
                    ],
                    "table": "Companies_users",
                    "returning": "id",
                    "query": "INSERT INTO Companies_users\n(userId, CompanyId) VALUES (:P1 /* {{insert_user_with_companyId.identity}} */, :P2 /* {{insert_Company.identity}} */)",
                    "params": [
                      {
                        "name": ":P1",
                        "type": "expression",
                        "value": "{{insert_user_with_companyId.identity}}"
                      },
                      {
                        "name": ":P2",
                        "type": "expression",
                        "value": "{{insert_Company.identity}}"
                      }
                    ]
                  }
                },
                "meta": [
                  {
                    "name": "identity",
                    "type": "text"
                  },
                  {
                    "name": "affected",
                    "type": "number"
                  }
                ]
              }
            ]
          },
          "else": {
            "steps": [
              {
                "name": "query",
                "module": "dbconnector",
                "action": "single",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "SELECT",
                    "columns": [
                      {
                        "table": "Company_Account",
                        "column": "id"
                      },
                      {
                        "table": "Company_Account",
                        "column": "CompanyName"
                      },
                      {
                        "table": "Company_Account",
                        "column": "Company_email"
                      }
                    ],
                    "table": {
                      "name": "Company_Account"
                    },
                    "joins": [],
                    "wheres": {
                      "condition": "AND",
                      "rules": [
                        {
                          "id": "Company_Account.id",
                          "field": "Company_Account.id",
                          "type": "double",
                          "operator": "equal",
                          "value": "{{$_POST.CompanyID}}",
                          "data": {
                            "table": "Company_Account",
                            "column": "id",
                            "type": "number"
                          },
                          "operation": "="
                        }
                      ],
                      "conditional": null,
                      "valid": true
                    },
                    "query": "SELECT id, CompanyName, Company_email\nFROM Company_Account\nWHERE id = :P1 /* {{$_POST.CompanyID}} */",
                    "params": [
                      {
                        "operator": "equal",
                        "type": "expression",
                        "name": ":P1",
                        "value": "{{$_POST.CompanyID}}"
                      }
                    ]
                  }
                },
                "output": true,
                "meta": [
                  {
                    "name": "id",
                    "type": "text"
                  },
                  {
                    "name": "CompanyName",
                    "type": "text"
                  },
                  {
                    "name": "Company_email",
                    "type": "text"
                  }
                ],
                "outputType": "object",
                "type": "dbconnector_single"
              },
              {
                "name": "insert_user_without_companyId",
                "module": "dbupdater",
                "action": "insert",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "insert",
                    "values": [
                      {
                        "table": "Users",
                        "column": "FirstName",
                        "type": "text",
                        "value": "{{$_POST.FirstName}}"
                      },
                      {
                        "table": "Users",
                        "column": "LastName",
                        "type": "text",
                        "value": "{{$_POST.LastName}}"
                      },
                      {
                        "table": "Users",
                        "column": "Email",
                        "type": "text",
                        "value": "{{$_POST.Email}}"
                      },
                      {
                        "table": "Users",
                        "column": "Role",
                        "type": "text",
                        "value": "{{$_POST.Role}}"
                      },
                      {
                        "table": "Users",
                        "column": "CreatedDate",
                        "type": "datetime",
                        "value": "{{NOW}}"
                      }
                    ],
                    "table": "Users",
                    "returning": "id",
                    "query": "INSERT INTO Users\n(FirstName, LastName, Email, Role, CreatedDate) VALUES (:P1 /* {{$_POST.FirstName}} */, :P2 /* {{$_POST.LastName}} */, :P3 /* {{$_POST.Email}} */, :P4 /* {{$_POST.Role}} */, :P5 /* {{NOW}} */)",
                    "params": [
                      {
                        "name": ":P1",
                        "type": "expression",
                        "value": "{{$_POST.FirstName}}"
                      },
                      {
                        "name": ":P2",
                        "type": "expression",
                        "value": "{{$_POST.LastName}}"
                      },
                      {
                        "name": ":P3",
                        "type": "expression",
                        "value": "{{$_POST.Email}}"
                      },
                      {
                        "name": ":P4",
                        "type": "expression",
                        "value": "{{$_POST.Role}}"
                      },
                      {
                        "name": ":P5",
                        "type": "expression",
                        "value": "{{NOW}}"
                      }
                    ]
                  }
                },
                "meta": [
                  {
                    "name": "identity",
                    "type": "text"
                  },
                  {
                    "name": "affected",
                    "type": "number"
                  }
                ]
              },
              {
                "name": "insert_user_company_join_table_copy",
                "module": "dbupdater",
                "action": "insert",
                "options": {
                  "connection": "db",
                  "sql": {
                    "type": "insert",
                    "values": [
                      {
                        "table": "Companies_users",
                        "column": "userId",
                        "type": "text",
                        "value": "{{insert_user_without_companyId.identity}}"
                      },
                      {
                        "table": "Companies_users",
                        "column": "CompanyId",
                        "type": "text",
                        "value": "{{query.id}}"
                      }
                    ],
                    "table": "Companies_users",
                    "returning": "id",
                    "query": "INSERT INTO Companies_users\n(userId, CompanyId) VALUES (:P1 /* {{insert_user_without_companyId.identity}} */, :P2 /* {{query.id}} */)",
                    "params": [
                      {
                        "name": ":P1",
                        "type": "expression",
                        "value": "{{insert_user_without_companyId.identity}}"
                      },
                      {
                        "name": ":P2",
                        "type": "expression",
                        "value": "{{query.id}}"
                      }
                    ]
                  }
                },
                "meta": [
                  {
                    "name": "identity",
                    "type": "text"
                  },
                  {
                    "name": "affected",
                    "type": "number"
                  }
                ]
              }
            ]
          }
        },
        "outputType": "boolean"
      },
      {
        "name": "refresh",
        "module": "sockets",
        "action": "refresh",
        "options": {
          "action": "App_query/User_company"
        }
      },
      {
        "name": "refresh_copy",
        "module": "sockets",
        "action": "refresh",
        "options": {
          "action": "App_query/All_Users"
        }
      }
    ]
  }
}